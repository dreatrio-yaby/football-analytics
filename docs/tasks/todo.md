
# Создание плоской таблицы

[x] На основе сырых данных из json-файлов, необходимо составить плоскую таблицу, в которую нужно вытащить ВСЕ поля из json-файлов.
  - используй базу данных raw

## Выполненные задачи

[x] Проанализировать все поля в sample/match.json для определения схемы таблицы
[x] Создать SQL скрипт для создания таблицы в базе raw с S3 движком
[x] Протестировать запрос на примере файла
[x] Проверить извлечение всех полей

## Созданные файлы

1. **create_match_stats_table.sql** - Создание таблицы raw.match_stats со всеми полями
2. **insert_match_stats.sql** - Запрос для заполнения таблицы из S3
3. **test_query.sql** - Простой тестовый запрос
4. **verify_all_fields.sql** - Проверка извлечения всех полей из всех разделов

## Обзор

Создана плоская таблица `raw.match_stats` с извлечением всех полей из JSON структуры:
- Основные поля: match_id, match_date, team_id
- Summary статистика: 26 полей (голы, передачи, атаки и т.д.)
- Passing статистика: 22 поля (статистика передач)
- Pass Types статистика: 15 полей (типы передач)
- Defensive Actions: 16 полей (защитные действия)
- Possession: 23 поля (владение мячом)
- Miscellaneous: 17 полей (разное)
- Goalkeeping: 23 поля (вратарская статистика)

Всего извлекается 142 поля из JSON структуры в плоскую таблицу.

Решение использует встроенные функции ClickHouse для чтения из S3 и извлечения JSON данных.

---

## GitHub Actions Автоматизация

### Выполненные задачи

[x] Создать файл .github/workflows/clickhouse-data-sync.yml
[x] Настроить триггеры (расписание, manual dispatch)
[x] Добавить шаги для выполнения SQL скриптов
[x] Создать список необходимых secrets
[x] Подготовить инструкцию по настройке secrets в GitHub
[x] Создать скрипт для проверки подключения к ClickHouse
[x] Создать скрипт для выполнения SQL команд с обработкой ошибок
[x] Создать README с инструкциями по настройке и использованию

### Созданные файлы для автоматизации

1. **.github/workflows/clickhouse-data-sync.yml** - GitHub Actions workflow
2. **scripts/test-connection.sh** - Проверка подключения к ClickHouse
3. **scripts/execute-sql.sh** - Выполнение SQL команд
4. **github-secrets.md** - Описание необходимых секретов
5. **README.md** - Полная документация проекта

### Возможности GitHub Actions

- **Автоматический запуск**: Каждый день в 2:00 UTC
- **Ручной запуск**: 4 типа операций (sync, create_table, test_connection, verify_data)
- **Мониторинг**: Логирование всех операций и статистики
- **Безопасность**: Использование GitHub Secrets для чувствительных данных

### Готовое решение

Проект полностью готов для использования с GitHub Actions:
1. Настройте секреты в GitHub
2. Запустите workflow вручную или дождитесь автоматического запуска
3. Мониторьте выполнение через раздел Actions
4. Данные автоматически загружаются из S3 в ClickHouse

---

## Безопасность секретов

### Выполненные задачи безопасности

[x] Заменить жестко прописанные ключи S3 на переменные окружения в SQL файлах
[x] Удалить реальные значения секретов из README.md
[x] Удалить файл github-secrets.md
[x] Проверить, что .env не попадает в коммит

### Меры безопасности

1. **SQL файлы**: Используют плейсхолдеры `{ACCESS_KEY_ID}` и `{ACCESS_KEY_SECRET}` вместо реальных ключей
2. **Скрипты**: Автоматически подставляют значения из переменных окружения
3. **GitHub Actions**: Использует секреты репозитория для подстановки значений
4. **Локальная разработка**: Файл `.env` исключен из Git через `.gitignore`
5. **Документация**: Все примеры используют плейсхолдеры вместо реальных данных

### Создан файл SETUP.md

Содержит инструкции по настройке секретов без раскрытия реальных значений.

✅ **Проект полностью безопасен для коммита в публичный репозиторий**

---

## Реорганизация структуры проекта

### Выполненные задачи по структурированию

[x] Создать новые директории для организации по слоям
[x] Переместить документацию в docs/
[x] Переместить SQL файлы raw слоя в data/raw/sql/
[x] Переместить примеры данных в data/raw/sample/
[x] Обновить пути в GitHub Actions workflow
[x] Обновить пути в скриптах
[x] Обновить ссылки в документации

### Новая структура проекта

```
.
├── .github/workflows/              # GitHub Actions
├── scripts/                        # Общие скрипты
├── docs/                           # Документация
│   ├── README.md                   # Полная документация
│   ├── SETUP.md                    # Инструкции по настройке
│   └── tasks/todo.md               # Задачи проекта
├── data/                           # Слои данных
│   └── raw/                        # Слой raw (текущий)
│       ├── sql/                    # SQL скрипты для raw
│       │   ├── create_tables.sql   # Создание таблиц
│       │   ├── insert_data.sql     # Загрузка данных
│       │   ├── test_queries.sql    # Тестовые запросы
│       │   └── verify_fields.sql   # Проверка полей
│       └── sample/                 # Примеры данных
├── README.md                       # Краткое описание с ссылками
└── claude.md                       # Инструкции проекта
```

### Преимущества новой структуры

1. **Четкое разделение по слоям данных** - готовность к добавлению staging, marts и других слоев
2. **Организованная документация** - все в папке docs/
3. **Структурированные SQL скрипты** - каждый слой в своей папке
4. **Масштабируемость** - легко добавлять новые слои данных
5. **Читаемость** - интуитивная навигация по проекту

✅ **Проект готов к развитию дополнительных слоев данных**

---

## Исправление SSL подключения к ClickHouse

### Выполненные задачи

[x] Добавить установку SSL сертификатов Yandex Cloud в GitHub Actions workflow
[x] Обновить документацию SETUP.md с информацией о SSL сертификатах

### Изменения

1. **GitHub Actions workflow** (.github/workflows/clickhouse-data-sync.yml)
   - Добавлен step для автоматической установки SSL сертификатов Yandex Cloud
   - Сертификаты загружаются с официальных URL и устанавливаются в систему Ubuntu

2. **Документация** (docs/SETUP.md)
   - Добавлена секция о SSL сертификатах
   - Обновлена секция безопасности

### Обзор

Исправлена проблема с SSL подключением к ClickHouse в GitHub Actions:
- Добавлена автоматическая установка сертификатов RootCA и IntermediateCA от Yandex Cloud
- Сертификаты устанавливаются в `/usr/local/share/ca-certificates/Yandex/`
- Выполняется обновление системных сертификатов через `update-ca-certificates`
- Документация обновлена с информацией о SSL сертификатах

✅ **GitHub Actions теперь должны корректно подключаться к ClickHouse**

---

## Исправление ошибки создания таблицы в GitHub Actions

### Выполненные задачи

[x] Создать отдельный SQL файл для создания базы данных
[x] Обновить файл create_tables.sql - убрать CREATE DATABASE
[x] Обновить GitHub Actions workflow - добавить отдельный шаг для создания базы
[x] Обновить документацию с информацией об исправлении

### Изменения

1. **Новый файл** (data/raw/sql/create_database.sql)
   - Содержит только команду создания базы данных
   - Изолирует создание базы от создания таблицы

2. **Обновленный файл** (data/raw/sql/create_tables.sql)
   - Убрана команда CREATE DATABASE
   - Содержит только создание таблицы

3. **GitHub Actions workflow** (.github/workflows/clickhouse-data-sync.yml)
   - Разделен на два отдельных шага: "Create database" и "Create table"
   - Улучшены сообщения об ошибках
   - Лучшая изоляция ошибок для отладки

### Обзор

Исправлена ошибка в GitHub Actions workflow при создании базы данных и таблицы:
- Проблема: Отправка нескольких SQL команд в одном HTTP запросе
- Решение: Разделение на отдельные шаги с отдельными файлами
- Преимущества: Лучшая изоляция ошибок, упрощенная отладка, более надежное выполнение

✅ **GitHub Actions теперь должны корректно создавать базу данных и таблицу**

---

## Исправление SQL запроса и добавление поля is_home

### Выполненные задачи

[x] Проанализировать полную структуру JSON файла
[x] Исправить ошибку JSONExtractKeysAndValues в SQL запросе
[x] Добавить поле is_home в схему таблицы
[x] Обновить документацию с решением

### Проблема
GitHub Actions падал с ошибкой `Unknown data type family: teams_stats` из-за некорректного использования `JSONExtractKeysAndValues()`.

### Изменения

1. **Схема таблицы** (data/raw/sql/create_tables.sql)
   - Добавлено поле `is_home UInt8` для различения домашней/гостевой команды

2. **SQL запрос** (data/raw/sql/insert_data.sql)
   - Заменен `JSONExtractKeysAndValues()` на `JSONExtractKeys()`
   - Использован UNION ALL для обработки двух команд отдельно
   - Первая команда в JSON считается домашней (is_home = 1)
   - Вторая команда считается гостевой (is_home = 0)

### Структура JSON
```json
{
  "match_id": "000fb8fc",
  "match_date": "2025-04-19", 
  "teams_stats": {
    "acbb6a5b": { /* статистика первой команды (домашняя) */ },
    "2ac661d9": { /* статистика второй команды (гостевая) */ }
  }
}
```

### Решение
- `arrayJoin(JSONExtractKeys(json, 'teams_stats'))[1]` - первая команда (домашняя)
- `arrayJoin(JSONExtractKeys(json, 'teams_stats'))[2]` - вторая команда (гостевая)
- UNION ALL создает две записи на каждый матч

✅ **SQL запрос исправлен и готов к тестированию**