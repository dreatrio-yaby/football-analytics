# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ ML Training Dataset workflow

## –ü—Ä–æ–±–ª–µ–º–∞ –∏ —Ä–µ—à–µ–Ω–∏–µ

### –ò—Å—Ö–æ–¥–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
1. ClickHouse 25.3.3 –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `!=` –≤ LEFT JOIN ON —É—Å–ª–æ–≤–∏—è—Ö
2. –ü–æ–¥–∑–∞–ø—Ä–æ—Å—ã –Ω–µ –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–Ω–µ—à–Ω–∏–º –∞–ª–∏–∞—Å–∞–º (`m1.team_id`)

**–û—à–∏–±–∫–∞ 1:**
```sql
LEFT JOIN match_results m2 ON m1.match_id = m2.match_id AND m1.team_id != m2.team_id
```

**–û—à–∏–±–∫–∞ 2:**
```sql
(SELECT goals_scored 
 FROM match_results m2 
 WHERE m2.match_id = m1.match_id AND m2.team_id != m1.team_id  -- –æ—à–∏–±–∫–∞: m1 –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
 LIMIT 1
) as goals_conceded
```

### –†–µ—à–µ–Ω–∏–µ
–ó–∞–º–µ–Ω–∏–ª–∏ –Ω–∞ –ø—Ä–æ—Å—Ç–æ–π INNER JOIN —Å `!=` (–∫–æ—Ç–æ—Ä—ã–π ClickHouse –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç):
```sql
FROM match_results m1
INNER JOIN match_results m2 ON (
    m1.match_id = m2.match_id 
    AND m1.team_id != m2.team_id
)
```

## –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –§–∞–π–ª `generate_team_features.sql`
- ‚úÖ –ó–∞–º–µ–Ω–µ–Ω LEFT JOIN –Ω–∞ INNER JOIN —Å `!=` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
- ‚úÖ –Ø–≤–Ω–æ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω—ã –≤—Å–µ –ø–æ–ª—è –≤–º–µ—Å—Ç–æ `SELECT *` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª—É—á–µ–Ω–∏–µ `xg_conceded` –æ—Ç –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ä–∞—Å—á–µ—Ç `xg_conceded_avg_*` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–ª—è

### 2. –§–∞–π–ª `ml-training-dataset.yml`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —à–∞–≥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ SQL –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º
- ‚úÖ –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª `test_generate_features.sql`

### 3. –§–∞–π–ª `test_generate_features.sql`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è INNER JOIN –≤–º–µ—Å—Ç–æ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –£–ø—Ä–æ—â–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏

### 4. –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã
- `test_generate_features.sql` - —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
- `TESTING.md` - –¥–∞–Ω–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ ClickHouse)
```bash
# –¢–µ—Å—Ç —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
curl -s "https://YOUR_CLICKHOUSE_HOST:8443/" \
  --user "user:password" \
  --data-binary @data/ml/sql/test_generate_features.sql
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ GitHub Actions
```bash
# –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü
gh workflow run ml-training-dataset.yml -f operation=create_ml_tables

# –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∞—Ç–∞—Å–µ—Ç–∞
gh workflow run ml-training-dataset.yml -f operation=build_dataset

# –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
gh workflow run ml-training-dataset.yml -f operation=verify_dataset
```

## –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏:
1. ‚úÖ –¢–µ—Å—Ç —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ SQL –ø—Ä–æ—Ö–æ–¥–∏—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
2. ‚úÖ –°–æ–∑–¥–∞–µ—Ç—Å—è view `ml.temp_team_features` 
3. ‚úÖ –°–æ–∑–¥–∞–µ—Ç—Å—è view `ml.temp_targets`
4. ‚úÖ –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–∞–±–ª–∏—Ü–∞ `ml.training_dataset`
5. ‚úÖ –ü—Ä–æ—Ö–æ–¥—è—Ç –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
6. ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–∞–Ω–Ω—ã–º

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
- **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö**: –ú–∏–Ω–∏–º—É–º 20 –º–∞—Ç—á–µ–π –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ë–æ–ª—å—à–∏–µ –¥–∞—Ç–∞—Å–µ—Ç—ã –º–æ–≥—É—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏
- **–ü—Ä–æ–ø—É—Å–∫–∏**: –ö–æ–º–∞–Ω–¥—ã —Å –º–∞–ª—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –º–∞—Ç—á–µ–π –º–æ–≥—É—Ç –∏–º–µ—Ç—å NULL –∑–Ω–∞—á–µ–Ω–∏—è

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ GitHub Actions
–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —ç—Ç–∞–ø—ã:
1. üîç Test team features syntax
2. ‚öôÔ∏è Generate team features  
3. üéØ Generate targets
4. üöÄ Build training dataset
5. üîç Verify training dataset quality

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ ClickHouse
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
SELECT COUNT(*) FROM ml.training_dataset;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö
SELECT 
  COUNT(*) as total_records,
  COUNT(DISTINCT match_id) as unique_matches,
  AVG(home_team_goals_avg_7) as avg_home_goals_7
FROM ml.training_dataset;
```

## –û—Ç–∫–∞—Ç –≤ —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º

### –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
```bash
gh workflow run ml-training-dataset.yml -f operation=cleanup
```

### –†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
```sql
DROP VIEW IF EXISTS ml.temp_team_features;
DROP VIEW IF EXISTS ml.temp_targets;
TRUNCATE TABLE ml.training_dataset;
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ workflow
2. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö
3. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å ML pipeline
4. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π