# Описание обучающей выборки для футбольной аналитики

## Обзор

Таблица `ml.training_dataset` содержит универсальную обучающую выборку для машинного обучения в футбольной аналитике. Каждая строка представляет один матч с признаками команд, вычисленными на основе предыдущих матчей, и таргетами текущего матча.

## Структура данных

### Технические поля (не используются как признаки)
- `match_id` - уникальный идентификатор матча
- `match_date` - дата проведения матча
- `home_team_id` - идентификатор домашней команды
- `away_team_id` - идентификатор гостевой команды

## Таргеты (target_*)

Все таргеты представляют собой бинарные классификационные задачи (0 или 1).

### Результат матча
- `target_match_result` - результат относительно домашней команды:
  - 0 = поражение домашней команды
  - 1 = ничья
  - 2 = победа домашней команды

### Тоталы голов
- `target_total_goals_over_0_5` - общее количество голов больше 0.5
- `target_total_goals_over_1_5` - общее количество голов больше 1.5
- `target_total_goals_over_2_5` - общее количество голов больше 2.5
- `target_total_goals_over_3_5` - общее количество голов больше 3.5
- `target_total_goals_over_4_5` - общее количество голов больше 4.5
- `target_total_goals_over_5_5` - общее количество голов больше 5.5

### Индивидуальные тоталы голов
**Домашняя команда:**
- `target_home_goals_over_0_5` - голы домашней команды больше 0.5
- `target_home_goals_over_1_5` - голы домашней команды больше 1.5
- `target_home_goals_over_2_5` - голы домашней команды больше 2.5
- `target_home_goals_over_3_5` - голы домашней команды больше 3.5

**Гостевая команда:**
- `target_away_goals_over_0_5` - голы гостевой команды больше 0.5
- `target_away_goals_over_1_5` - голы гостевой команды больше 1.5
- `target_away_goals_over_2_5` - голы гостевой команды больше 2.5
- `target_away_goals_over_3_5` - голы гостевой команды больше 3.5

### Угловые удары
- `target_corners_over_8_5` - общее количество угловых больше 8.5
- `target_corners_over_9_5` - общее количество угловых больше 9.5
- `target_corners_over_10_5` - общее количество угловых больше 10.5
- `target_corners_over_11_5` - общее количество угловых больше 11.5
- `target_corners_over_12_5` - общее количество угловых больше 12.5

### Карточки
- `target_cards_over_2_5` - общее количество карточек больше 2.5
- `target_cards_over_3_5` - общее количество карточек больше 3.5
- `target_cards_over_4_5` - общее количество карточек больше 4.5
- `target_cards_over_5_5` - общее количество карточек больше 5.5

### Фолы
- `target_fouls_over_18_5` - общее количество фолов больше 18.5
- `target_fouls_over_20_5` - общее количество фолов больше 20.5
- `target_fouls_over_22_5` - общее количество фолов больше 22.5
- `target_fouls_over_24_5` - общее количество фолов больше 24.5

## Признаки (features)

### Временные окна
Все признаки вычисляются для трех временных окон:
- **_3** - последние 3 матча (исключая текущий)
- **_7** - последние 7 матчей (исключая текущий)
- **_11** - последние 11 матчей (исключая текущий)

### Признаки домашней команды (home_team_*)

**Голы и атака:**
- `goals_avg_X` - среднее количество забитых голов за X матчей
- `goals_sum_X` - общее количество забитых голов за X матчей
- `goals_conceded_avg_X` - среднее количество пропущенных голов за X матчей
- `goals_conceded_sum_X` - общее количество пропущенных голов за X матчей
- `shots_avg_X` - среднее количество ударов за X матчей
- `shots_on_target_avg_X` - среднее количество ударов в створ за X матчей
- `shots_on_target_pct_X` - процент ударов в створ за X матчей

**Expected Goals (xG):**
- `xg_avg_X` - среднее значение xG за X матчей
- `xg_sum_X` - общее значение xG за X матчей
- `xg_conceded_avg_X` - среднее значение xG противника за X матчей

**Пасы и владение:**
- `passes_completed_avg_X` - среднее количество точных пасов за X матчей
- `passes_pct_X` - процент точности пасов за X матчей
- `progressive_passes_avg_X` - среднее количество прогрессивных пасов за X матчей
- `possession_avg_X` - среднее владение мячом за X матчей

**Оборона:**
- `tackles_avg_X` - среднее количество отборов за X матчей
- `interceptions_avg_X` - среднее количество перехватов за X матчей

**Дисциплина:**
- `fouls_avg_X` - среднее количество фолов за X матчей
- `cards_yellow_avg_X` - среднее количество желтых карточек за X матчей
- `cards_red_avg_X` - среднее количество красных карточек за X матчей

**Стандартные положения:**
- `corners_avg_X` - среднее количество угловых за X матчей
- `crosses_avg_X` - среднее количество навесов за X матчей

**Индивидуальные действия:**
- `take_ons_won_pct_X` - процент успешных дриблингов за X матчей
- `aerials_won_pct_X` - процент выигранных воздушных дуэлей за X матчей

**Форма команды:**
- `form_X` - средний результат за X матчей (0-2, где 0=поражение, 1=ничья, 2=победа)

### Признаки гостевой команды (away_team_*)

Полностью аналогичны признакам домашней команды, но для гостевой команды.

### Признаки взаимодействия команд

**Разности (diff_*):**
- `diff_goals_avg_X` - разность средних голов (домашняя - гостевая)
- `diff_goals_conceded_avg_X` - разность средних пропущенных голов
- `diff_xg_avg_X` - разность средних xG
- `diff_shots_avg_X` - разность средних ударов
- `diff_possession_avg_X` - разность среднего владения мячом
- `diff_form_X` - разность форм команд

**Отношения (ratio_*):**
- `ratio_goals_avg_X` - отношение средних голов (домашняя / гостевая)
- `ratio_xg_avg_X` - отношение средних xG
- `ratio_shots_avg_X` - отношение средних ударов

### Производные признаки

**Эффективность атаки:**
- `home_team_attack_efficiency_X` - эффективность атаки домашней команды (голы/удары)
- `away_team_attack_efficiency_X` - эффективность атаки гостевой команды

**Эффективность защиты:**
- `home_team_defense_efficiency_X` - эффективность защиты домашней команды (пропущенные голы/удары в створ противника)
- `away_team_defense_efficiency_X` - эффективность защиты гостевой команды

**Стабильность:**
- `home_team_goals_std_X` - стандартное отклонение голов домашней команды за X матчей
- `away_team_goals_std_X` - стандартное отклонение голов гостевой команды за X матчей

## Использование

### Примеры запросов

```sql
-- Получить все признаки для предсказания результата матча
SELECT 
    match_id,
    match_date,
    home_team_id,
    away_team_id,
    target_match_result,
    home_team_*,
    away_team_*,
    diff_*,
    ratio_*
FROM ml.training_dataset
WHERE match_date >= '2023-01-01';

-- Получить только признаки (исключить таргеты)
SELECT 
    match_id,
    match_date,
    home_team_id,
    away_team_id,
    * EXCEPT (target_*)
FROM ml.training_dataset;

-- Получить только таргеты
SELECT 
    match_id,
    match_date,
    home_team_id,
    away_team_id,
    target_*
FROM ml.training_dataset;
```

### Рекомендации по использованию

1. **Фильтрация данных**: Исключайте матчи с недостаточной историей (менее 11 предыдущих матчей)

2. **Обработка пропусков**: Проверяйте наличие NULL значений и обрабатывайте их соответствующим образом

3. **Временное разделение**: Используйте временное разделение для train/validation/test (например, по сезонам)

4. **Нормализация**: Рассмотрите нормализацию признаков перед обучением

5. **Выбор признаков**: Начните с признаков окна 7 матчей как базовых, затем добавляйте другие окна

6. **Обработка дисбаланса**: Некоторые таргеты могут быть сильно дисбалансированы (например, тоталы 5.5+)

## Примеры использования по типам задач

### Предсказание результата матча
```sql
SELECT 
    target_match_result,
    home_team_form_7,
    away_team_form_7,
    diff_goals_avg_7,
    diff_xg_avg_7,
    ratio_goals_avg_7
FROM ml.training_dataset;
```

### Предсказание тотала голов
```sql
SELECT 
    target_total_goals_over_2_5,
    home_team_goals_avg_7,
    away_team_goals_avg_7,
    home_team_xg_avg_7,
    away_team_xg_avg_7,
    home_team_attack_efficiency_7,
    away_team_attack_efficiency_7
FROM ml.training_dataset;
```

### Предсказание угловых
```sql
SELECT 
    target_corners_over_10_5,
    home_team_corners_avg_7,
    away_team_corners_avg_7,
    home_team_crosses_avg_7,
    away_team_crosses_avg_7
FROM ml.training_dataset;
```

## Обновление данных

Для обновления обучающей выборки выполните:

1. Обновите таблицу `raw.match_stats` новыми данными
2. Запустите скрипт `build_training_dataset.sql`
3. Проверьте качество данных и наличие пропусков
4. Переобучите модели с новыми данными

## Метрики качества

Рекомендуемые метрики для оценки моделей:

- **Результат матча**: Accuracy, F1-macro, Log-loss
- **Тоталы**: AUC-ROC, Precision, Recall, F1-score
- **Редкие события**: Precision@K, Recall@K для топ-k предсказаний